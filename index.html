<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC_HDixly65xT9PcuktvtGQ7pCMI_HQXEc",
    authDomain: "game-71234.firebaseapp.com",
    databaseURL: "https://game-71234-default-rtdb.firebaseio.com",
    projectId: "game-71234",
    storageBucket: "game-71234.firebasestorage.app",
    messagingSenderId: "487318758592",
    appId: "1:487318758592:web:0f57e534a5154a8a127925"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const menu = document.getElementById("menu");
  const gameArea = document.getElementById("gameArea");
  const boardElement = document.getElementById("board");
  const statusElement = document.getElementById("status");
  const modeTitle = document.getElementById("modeTitle");

  const playBotBtn = document.getElementById("playBot");
  const createRoomBtn = document.getElementById("createRoom");
  const joinRoomBtn = document.getElementById("joinRoom");

  let board = Array(9).fill(null);
  let mySymbol = "X";
  let botMode = false;
  let roomRef = null;
  let roomData = null;

  const winningCombos = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];

  function renderBoard() {
    boardElement.innerHTML = "";
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.index = i;
      cell.textContent = board[i] || "";
      cell.onclick = cellClick;
      boardElement.appendChild(cell);
    }
  }

  function botMove() {
    const empty = board.map((v,i)=>v===null?i:null).filter(v=>v!==null);
    if (empty.length === 0) return;

    for (let idx of empty) {
      const copy = [...board];
      copy[idx] = "O";
      if (checkWinner(copy,"O")) { makeMove(idx,"O"); return; }
    }

    for (let idx of empty) {
      const copy = [...board];
      copy[idx] = "X";
      if (checkWinner(copy,"X")) { makeMove(idx,"O"); return; }
    }

    const idx = empty[Math.floor(Math.random()*empty.length)];
    makeMove(idx,"O");
  }

  function makeMove(index, symbol) {
    if (board[index] !== null) return;
    board[index] = symbol;
    renderBoard();

    if (checkWinner(board, symbol)) {
      statusElement.textContent = symbol + " Wins! ðŸ†";
      return;
    }
    if (board.every(c => c !== null)) {
      statusElement.textContent = "Draw! ðŸ¤";
      return;
    }
  }

  function cellClick(e) {
    const index = Number(e.target.dataset.index);

    if (botMode) {
      if (board[index] !== null) return;
      makeMove(index, "X");
      setTimeout(botMove, 300);
      return;
    }

    if (!roomData) return;
    if (mySymbol !== roomData.turn) return;
    if (board[index] !== null) return;

    board[index] = mySymbol;
    updateRoom();
  }

  function checkWinner(b, p) {
    return winningCombos.some(combo =>
      combo.every(i => b[i] === p)
    );
  }

  // BOT MODE
  playBotBtn.onclick = () => {
    botMode = true;
    menu.style.display = "none";
    gameArea.style.display = "block";
    modeTitle.textContent = "Playing vs Bot ðŸ¤–";
    board = Array(9).fill(null);
    renderBoard();
    statusElement.textContent = "Your turn (X)";
  };

  // CREATE ROOM
  createRoomBtn.onclick = async () => {
    const name = document.getElementById("playerName").value.trim();
    const code = document.getElementById("roomCode").value.trim().toUpperCase();

    if (!name || !code) {
      alert("Enter your name AND a room code.");
      return;
    }

    mySymbol = "X";
    roomRef = db.ref("rooms/" + code);

    await roomRef.set({
      board: Array(9).fill(null),
      turn: "X",
      status: "waiting",
      players: { X: name, O: null }
    });

    startOnline(code);
  };

  // JOIN ROOM
  joinRoomBtn.onclick = async () => {
    const name = document.getElementById("playerName").value.trim();
    const code = document.getElementById("roomCode").value.trim().toUpperCase();

    if (!name || !code) {
      alert("Enter your name AND a room code.");
      return;
    }

    roomRef = db.ref("rooms/" + code);
    const snap = await roomRef.get();

    if (!snap.exists()) {
      alert("Room not found. Ask your friend for the correct code.");
      return;
    }

    const data = snap.val();

    if (!data.players || !data.players.X) {
      mySymbol = "X";
      await roomRef.update({
        "players/X": name,
        status: "waiting",
        board: data.board || Array(9).fill(null)
      });
    } else if (!data.players.O) {
      mySymbol = "O";
      await roomRef.update({
        "players/O": name,
        status: "playing",
        board: data.board || Array(9).fill(null)
      });
    } else {
      alert("Room is already full.");
      return;
    }

    startOnline(code);
  };

  function startOnline(code) {
    botMode = false;
    menu.style.display = "none";
    gameArea.style.display = "block";
    modeTitle.textContent = "Online Room " + code;

    roomRef.on("value", snap => {
      roomData = snap.val();
      if (!roomData) return;

      if (!Array.isArray(roomData.board) || roomData.board.length !== 9) {
        board = Array(9).fill(null);
      } else {
        board = roomData.board;
      }

      renderBoard();

      if (roomData.status === "waiting") {
        statusElement.textContent = "Waiting for opponent to joinâ€¦";
        return;
      }

      if (roomData.status === "playing") {
        statusElement.textContent = "Turn: " + roomData.turn;
      }

      if (roomData.status === "finished") {
        if (roomData.winner === "draw") {
          statusElement.textContent = "Draw! ðŸ¤";
        } else {
          statusElement.textContent = roomData.winner + " Wins! ðŸ†";
        }
      }
    });
  }

  function updateRoom() {
    const result = checkWinner(board, mySymbol)
      ? "win"
      : board.every(c => c !== null)
      ? "draw"
      : "ongoing";

    const updates = { board };

    if (result === "win") {
      updates.status = "finished";
      updates.winner = mySymbol;
    } else if (result === "draw") {
      updates.status = "finished";
      updates.winner = "draw";
    } else {
      updates.turn = mySymbol === "X" ? "O" : "X";
    }

    roomRef.update(updates);
  }
</script>
